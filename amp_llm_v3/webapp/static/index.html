<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMP LLM - Clinical Trial Research</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            height: 90vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        /* Menu Section */
        .menu-section {
            padding: 40px;
            text-align: center;
        }

        .menu-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 30px;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .menu-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 30px 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .menu-item-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .menu-item-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .menu-item-desc {
            font-size: 0.9em;
            color: #666;
        }

        /* Mode Containers */
        .mode-container {
            display: none !important;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .mode-container.active {
            display: flex !important;
        }

        .mode-header {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-button {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .back-button:hover {
            background: #5a6268;
        }

        .mode-title {
            font-size: 1.5em;
            color: #333;
            font-weight: bold;
        }

        /* NCT Lookup Styles */
        .nct-input-area {
            padding: 30px;
            background: #f8f9fa;
        }

        .nct-input-group {
            margin-bottom: 20px;
        }

        .nct-input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #495057;
        }

        .nct-input-group input,
        .nct-input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-size: 15px;
        }

        .nct-input-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .nct-submit {
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .nct-results {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .result-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        /* Chat Styles (kept from original) */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #ffffff;
        }

        .message {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            background: #f8f9fa;
        }

        .content {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 15px;
            max-width: 70%;
            line-height: 1.6;
        }

        .message.user .content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .input-area {
            display: flex;
            gap: 15px;
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .input-area textarea {
            flex: 1;
            padding: 15px;
            border: 2px solid #ced4da;
            border-radius: 12px;
            font-size: 15px;
            resize: none;
        }

        .input-area button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî¨ AMP LLM</h1>
            <p>Clinical Trial Research Assistant</p>
        </header>

        <!-- Main Menu -->
        <div id="menu-view" class="menu-section">
            <h2 class="menu-title">Select a Mode</h2>
            <div class="menu-grid">
                <div class="menu-item" onclick="showMode('chat')">
                    <div class="menu-item-icon">üí¨</div>
                    <div class="menu-item-title">Chat with LLM</div>
                    <div class="menu-item-desc">General purpose AI chat</div>
                </div>

                <div class="menu-item" onclick="showMode('nct-lookup')">
                    <div class="menu-item-icon">üîç</div>
                    <div class="menu-item-title">NCT Lookup</div>
                    <div class="menu-item-desc">Search clinical trials by NCT number</div>
                </div>

                <div class="menu-item" onclick="showMode('research')">
                    <div class="menu-item-icon">üìö</div>
                    <div class="menu-item-title">Research Assistant</div>
                    <div class="menu-item-desc">RAG-powered trial analysis</div>
                </div>

                <div class="menu-item" onclick="showMode('stats')">
                    <div class="menu-item-icon">üìä</div>
                    <div class="menu-item-title">Database Stats</div>
                    <div class="menu-item-desc">View indexed trials</div>
                </div>
            </div>
        </div>

        <!-- Chat Mode -->
        <div id="chat-mode" class="mode-container">
            <div class="mode-header">
                <button class="back-button" onclick="showMenu()">‚Üê Back</button>
                <div class="mode-title">üí¨ Chat Mode</div>
            </div>
            <div class="chat-container" id="chat-container"></div>
            <div class="input-area">
                <textarea id="chat-input" placeholder="Ask a question..." rows="3"></textarea>
                <button onclick="sendChat()">Send</button>
            </div>
        </div>

        <!-- NCT Lookup Mode -->
        <div id="nct-mode" class="mode-container">
            <div class="mode-header">
                <button class="back-button" onclick="showMenu()">‚Üê Back</button>
                <div class="mode-title">üîç NCT Lookup</div>
            </div>
            <div class="nct-input-area">
                <div class="nct-input-group">
                    <label>Enter NCT Numbers (comma-separated):</label>
                    <textarea id="nct-input" placeholder="NCT12345678, NCT87654321"></textarea>
                </div>
                <button class="nct-submit" onclick="lookupNCT()">Fetch Trials</button>
            </div>
            <div class="nct-results" id="nct-results"></div>
        </div>

        <!-- Research Mode -->
        <div id="research-mode" class="mode-container">
            <div class="mode-header">
                <button class="back-button" onclick="showMenu()">‚Üê Back</button>
                <div class="mode-title">üìö Research Assistant</div>
            </div>
            <div class="chat-container" id="research-container"></div>
            <div class="input-area">
                <textarea id="research-input" placeholder="Ask about clinical trials..." rows="3"></textarea>
                <button onclick="sendResearch()">Research</button>
            </div>
        </div>

        <!-- Stats Mode -->
        <div id="stats-mode" class="mode-container">
            <div class="mode-header">
                <button class="back-button" onclick="showMenu()">‚Üê Back</button>
                <div class="mode-title">üìä Database Statistics</div>
            </div>
            <div class="nct-results" id="stats-container">
                <div class="loading">Loading statistics...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const API_KEY = localStorage.getItem('amp_llm_api_key') || 'YOUR_KEY_HERE';

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, showing menu');
            showMenu();
        });

        function showMenu() {
            console.log('Showing menu');
            const menu = document.getElementById('menu-view');
            if (menu) {
                menu.style.display = 'block';
            }
            document.querySelectorAll('.mode-container').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });
        }

        function showMode(mode) {
            console.log('Showing mode:', mode);
            const menu = document.getElementById('menu-view');
            if (menu) {
                menu.style.display = 'none';
            }
            
            // Hide all modes first
            document.querySelectorAll('.mode-container').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });
            
            // Show selected mode
            const modeElement = document.getElementById(mode + '-mode');
            if (modeElement) {
                modeElement.style.display = 'flex';
                modeElement.classList.add('active');
                console.log('Mode element found and displayed');
            } else {
                console.error('Mode element not found:', mode + '-mode');
            }

            if (mode === 'stats') {
                loadStats();
            }
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const query = input.value.trim();
            if (!query) return;

            addMessage('chat-container', 'user', query);
            input.value = '';

            try {
                const response = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        query: query,
                        model: 'llama3.2'
                    })
                });

                const data = await response.json();
                addMessage('chat-container', 'assistant', data.response);
            } catch (error) {
                addMessage('chat-container', 'error', 'Error: ' + error.message);
            }
        }

        async function lookupNCT() {
            const input = document.getElementById('nct-input');
            const nctIds = input.value.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            
            if (nctIds.length === 0) {
                alert('Please enter at least one NCT number');
                return;
            }

            const resultsDiv = document.getElementById('nct-results');
            resultsDiv.innerHTML = '<div class="loading">Fetching trials...</div>';

            try {
                const response = await fetch(`${API_BASE}/nct-lookup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        nct_ids: nctIds,
                        use_extended_apis: false
                    })
                });

                const data = await response.json();
                displayNCTResults(data);
            } catch (error) {
                resultsDiv.innerHTML = `<div class="result-card"><h3>Error</h3><p>${error.message}</p></div>`;
            }
        }

        function displayNCTResults(data) {
            const resultsDiv = document.getElementById('nct-results');
            resultsDiv.innerHTML = '';

            if (data.results.length === 0) {
                resultsDiv.innerHTML = '<div class="result-card"><h3>No Results</h3><p>No trials found</p></div>';
                return;
            }

            data.results.forEach(result => {
                const card = document.createElement('div');
                card.className = 'result-card';
                
                const sources = result.sources || {};
                const ct = sources.clinical_trials?.data?.protocolSection || {};
                const ident = ct.identificationModule || {};
                
                card.innerHTML = `
                    <h3>${result.nct_id}</h3>
                    <p><strong>Title:</strong> ${ident.officialTitle || ident.briefTitle || 'N/A'}</p>
                    <p><strong>PubMed Articles:</strong> ${sources.pubmed?.pmids?.length || 0}</p>
                    <p><strong>PMC Articles:</strong> ${sources.pmc?.pmcids?.length || 0}</p>
                `;
                
                resultsDiv.appendChild(card);
            });
        }

        async function sendResearch() {
            const input = document.getElementById('research-input');
            const query = input.value.trim();
            if (!query) return;

            addMessage('research-container', 'user', query);
            input.value = '';

            try {
                const response = await fetch(`${API_BASE}/research`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        query: query,
                        model: 'llama3.2',
                        max_trials: 10
                    })
                });

                const data = await response.json();
                addMessage('research-container', 'assistant', 
                    `${data.answer}\n\n(Used ${data.trials_used} trial(s))`);
            } catch (error) {
                addMessage('research-container', 'error', 'Error: ' + error.message);
            }
        }

        async function loadStats() {
            const container = document.getElementById('stats-container');
            
            try {
                const response = await fetch(`${API_BASE}/stats`, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`
                    }
                });

                const data = await response.json();
                
                container.innerHTML = `
                    <div class="result-card">
                        <h3>üìä Database Overview</h3>
                        <p><strong>Total Trials:</strong> ${data.total_trials || 0}</p>
                        <p><strong>Peptide Trials:</strong> ${data.peptide_trials || 0}</p>
                    </div>
                    <div class="result-card">
                        <h3>üìà By Status</h3>
                        ${Object.entries(data.by_status || {}).map(([status, count]) => 
                            `<p><strong>${status}:</strong> ${count}</p>`
                        ).join('')}
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<div class="result-card"><h3>Error</h3><p>${error.message}</p></div>`;
            }
        }

        function addMessage(containerId, role, text) {
            const container = document.getElementById(containerId);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = role === 'user' ? 'üë§' : 'ü§ñ';
            
            const content = document.createElement('div');
            content.className = 'content';
            content.textContent = text;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>